<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pocket Classroom — Author (Quiz UI improved)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{
      --bg:#071427; --panel:rgba(255,255,255,0.03); --muted:#86a0b6;
      --accent:#32d1b6; --danger:#ff6b6b; --input-border:rgba(255,255,255,0.06);
    }
    html,body{
      height:100%;
      background:linear-gradient(180deg,#04101a 0%,#071427 60%);
      color:#e6f3f8;
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
      font-size:14px;
    }
    .container{max-width:1200px}
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    .panel{background:var(--panel);border-radius:10px;padding:16px;border:1px solid rgba(255,255,255,0.02)}
    .card-block{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:8px}
    .form-control, .form-select, textarea{background:transparent;border:1px solid var(--input-border);color:inherit;border-radius:6px;padding:.5rem}
    .form-control:focus, .form-select:focus, textarea:focus{outline:none;box-shadow:0 0 0 3px rgba(50,209,182,0.08);border-color:rgba(76,192,255,0.22)}
    .small-muted{color:var(--muted)}
    .btn-accent{background:linear-gradient(90deg,var(--accent),#4cc0ff);border:none;color:#022}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
    .section-title{font-weight:600;color:#dff6f1;margin-bottom:8px}
    .meta-grid{display:grid;grid-template-columns:1fr 220px;gap:12px}
    .notes-area{height:160px}
    .compact-input{height:40px;padding:.35rem .5rem}
    .json-out{background:#021018;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);max-height:240px;overflow:auto}
    .flashcard-row{display:flex;gap:8px;align-items:flex-start;margin-bottom:8px}
    .quiz-block{margin-bottom:12px;border-radius:10px;padding:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));border:1px solid rgba(255,255,255,0.02)}
    /* QUIZ-specific layout from screenshot */
    .quiz-question{
      width:100%;
      border-radius:12px;
      border:1px solid var(--input-border);
      padding:12px 14px;
      font-size:15px;
      background:transparent;
    }
    .choices-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .choice-input{
      border-radius:8px;
      padding:.6rem;
      height:42px;
      border:1px solid var(--input-border);
      background:transparent;
    }
    .quiz-controls{
      display:flex;
      gap:10px;
      align-items:center;
      margin-top:12px;
    }
    .correct-input{
      width:70px;
      padding:.45rem;
      border-radius:8px;
      text-align:center;
      border:1px solid var(--input-border);
      background:transparent;
    }
    .explain-input{
      flex:1;
      padding:.45rem;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.03);
      color:rgba(255,255,255,0.65);
    }
    .remove-btn{
      background:linear-gradient(135deg,#a83a3a,#ff6b6b);
      color:#fff;border:none;padding:.5rem .7rem;border-radius:8px;
    }
    @media (max-width:991px){
      .meta-grid{grid-template-columns:1fr}
      .notes-area{height:120px}
      .choices-grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="container my-4">
    <div class="topbar">
      <div>
        <h4 class="m-0">Pocket Classroom</h4>
        <div class="small-muted">Author Capsule — draft notes, flashcards, and quizzes. Auto-saves locally.</div>
      </div>
      <div>
        <button id="btn-back" class="btn btn-ghost btn-sm me-2">← Back</button>
        <button id="btn-save" class="btn btn-accent btn-sm">Save</button>
      </div>
    </div>

    <div class="row g-3">
      <!-- meta -->
      <div class="col-12 col-md-6">
        <section class="panel">
          <div class="section-title">Meta</div>
          <div class="meta-grid">
            <div>
              <label class="small-muted">Title <span style="color:var(--danger)">*</span></label>
              <input id="meta-title" class="form-control compact-input" placeholder="Introduction to Unity" />
              <div id="err-title" class="text-danger small d-none">Title required</div>
              <div class="mt-2">
                <label class="small-muted">Description</label>
                <textarea id="meta-desc" class="form-control" rows="3" placeholder="Short description"></textarea>
              </div>
            </div>
            <div>
              <label class="small-muted">Notes (quick)</label>
              <textarea id="notes-side" class="form-control notes-area" placeholder="Short notes..."></textarea>
            </div>
          </div>

          <div class="row mt-3 g-2">
            <div class="col-6">
              <label class="small-muted">Subject</label>
              <input id="meta-subject" class="form-control compact-input" placeholder="Gaming" />
            </div>
            <div class="col-6">
              <label class="small-muted">Level</label>
              <select id="meta-level" class="form-select compact-input">
                <option>Beginner</option><option>Intermediate</option><option>Advanced</option>
              </select>
            </div>
          </div>
        </section>
      </div>

      <!-- main notes -->
      <div class="col-12 col-md-6">
        <section class="panel">
          <div class="section-title">Notes <span class="small-muted">(one idea per line)</span></div>
          <textarea id="notes-area" class="form-control notes-area" placeholder="Unity is used for developing infrastructure and making games including 2D or 3D games..."></textarea>
        </section>
      </div>

      <!-- flashcards -->
      <div class="col-12 col-md-6">
        <section class="panel">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="section-title m-0">Flashcards</div>
            <div>
              <button id="add-flashcard" class="btn btn-ghost btn-sm">+ Add</button>
              <button id="clear-flashcards" class="btn btn-ghost btn-sm ms-1">Clear</button>
            </div>
          </div>
          <div id="flashcards-list"></div>
          <div id="flashcards-empty" class="small-muted mt-2">No flashcards yet.</div>
        </section>
      </div>

      <!-- quiz -->
      <div class="col-12 col-md-6">
        <section class="panel">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="section-title m-0">Quiz</div>
            <div>
              <button id="add-quiz" class="btn btn-ghost btn-sm">+ Add</button>
              <button id="clear-quiz" class="btn btn-ghost btn-sm ms-1">Clear</button>
            </div>
          </div>

          <div id="quiz-list"></div>
          <div id="quiz-empty" class="small-muted mt-2">No quiz questions yet.</div>
        </section>
      </div>
    </div>

    <!-- preview + json -->
    <div class="row mt-3">
      <div class="col-12">
        <section class="panel d-flex gap-3 align-items-start">
          <div style="flex:1">
            <div class="small-muted">Preview</div>
            <div id="preview-area" class="card-block mt-2">Title will appear after typing</div>
          </div>
          <div style="width:420px">
            <div class="small-muted">Capsule JSON (saved)</div>
            <pre id="json-out" class="json-out mt-2">{ /* capsule JSON appears after Save */ }</pre>
            <div class="d-flex gap-2 mt-2">
              <input id="import-file" type="file" accept="application/json" class="form-control form-control-sm" />
              <button id="btn-export" class="btn btn-ghost btn-sm">Export</button>
              <button id="btn-new" class="btn btn-ghost btn-sm">New</button>
              <button id="btn-clear-draft" class="btn btn-ghost btn-sm">Clear Draft</button>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <script>
  (function(){
    const LS_INDEX = 'pc_capsules_index';
    const LS_CAP_PREFIX = 'pc_capsule_';
    const DRAFT_KEY = 'pc_author_draft';

    const $ = s => document.querySelector(s);
    const nowISO = () => (new Date()).toISOString();
    const slug = s => String(s||'').toLowerCase().replace(/[^a-z0-9\-]+/g,'-').replace(/^-|-$/g,'');

    let currentId = null;
    let autosaveTimer = null;
    let state = {
      meta: { title:'', subject:'', level:'Beginner', description:'' },
      notes: [],
      flashcards: [],
      quiz: []
    };

    // refs
    let titleEl, subjectEl, levelEl, descEl, notesArea, notesSide, flashList, flashEmpty, quizList, quizEmpty, previewArea, jsonOut;

    document.addEventListener('DOMContentLoaded', () => {
      titleEl = document.getElementById('meta-title');
      subjectEl = document.getElementById('meta-subject');
      levelEl = document.getElementById('meta-level');
      descEl = document.getElementById('meta-desc');
      notesArea = document.getElementById('notes-area');
      notesSide = document.getElementById('notes-side');
      flashList = document.getElementById('flashcards-list');
      flashEmpty = document.getElementById('flashcards-empty');
      quizList = document.getElementById('quiz-list');
      quizEmpty = document.getElementById('quiz-empty');
      previewArea = document.getElementById('preview-area');
      jsonOut = document.getElementById('json-out');

      // UI wiring
      document.getElementById('add-flashcard').addEventListener('click', ()=>{ addFlashcard(); renderFlashcards(); autoSave(); });
      document.getElementById('clear-flashcards').addEventListener('click', ()=>{ state.flashcards = []; renderFlashcards(); autoSave(); });
      document.getElementById('add-quiz').addEventListener('click', ()=>{ addQuiz(); renderQuiz(); autoSave(); });
      document.getElementById('clear-quiz').addEventListener('click', ()=>{ state.quiz = []; renderQuiz(); autoSave(); });
      document.getElementById('btn-save').addEventListener('click', onSave);
      document.getElementById('btn-export').addEventListener('click', onExport);
      document.getElementById('btn-new').addEventListener('click', resetEditor);
      document.getElementById('btn-clear-draft').addEventListener('click', ()=>{ localStorage.removeItem(DRAFT_KEY); alert('Draft cleared'); });
      document.getElementById('import-file').addEventListener('change', onImportFile);
      document.getElementById('btn-back').addEventListener('click', ()=>{ alert('Back pressed'); });

      [titleEl, subjectEl, levelEl, descEl, notesArea, notesSide].forEach(el=>{
        el.addEventListener('input', ()=>{ updateFromInputs(); autoSave(); renderPreview(); });
      });

      loadDraft();
      renderAll();
    });

    function loadDraft(){
      try{
        const raw = localStorage.getItem(DRAFT_KEY);
        if(!raw) return;
        const parsed = JSON.parse(raw);
        Object.assign(state, parsed.state || parsed);
        currentId = parsed.id || null;
        console.log('Draft loaded');
      }catch(e){ console.warn('draft load failed', e); }
    }

    function autoSave(){
      if(autosaveTimer) clearTimeout(autosaveTimer);
      autosaveTimer = setTimeout(()=>{
        try{
          updateFromInputs();
          const payload = { id: currentId, state, updatedAt: nowISO() };
          localStorage.setItem(DRAFT_KEY, JSON.stringify(payload));
          console.log('Draft autosaved');
        }catch(e){ console.warn(e); }
      }, 700);
    }

    function updateFromInputs(){
      state.meta.title = titleEl.value.trim();
      state.meta.subject = subjectEl.value.trim();
      state.meta.level = levelEl.value;
      state.meta.description = descEl.value.trim();
      state.notes = notesArea.value.split('\n').map(s=>s.trim()).filter(Boolean);
      notesSide.value = state.notes.join('\n');
    }

    function renderAll(){
      titleEl.value = state.meta.title || '';
      subjectEl.value = state.meta.subject || '';
      levelEl.value = state.meta.level || 'Beginner';
      descEl.value = state.meta.description || '';
      notesArea.value = (state.notes || []).join('\n');
      notesSide.value = (state.notes || []).join('\n');
      renderFlashcards();
      renderQuiz();
      renderPreview();
    }

    function renderPreview(){
      previewArea.textContent = state.meta.title ? `${state.meta.title} — ${state.meta.subject || ''} • ${state.meta.level}` : 'Title will appear after typing';
    }

    /* FLASHCARDS (unchanged) */
    function renderFlashcards(){
      flashList.innerHTML = '';
      const arr = state.flashcards || [];
      if(!arr.length){ flashEmpty.style.display = 'block'; return; }
      flashEmpty.style.display = 'none';
      arr.forEach((f,i)=>{
        const row = document.createElement('div'); row.className = 'flashcard-row';
        const inFront = document.createElement('input'); inFront.className='form-control'; inFront.placeholder='Front'; inFront.value = f.front||''; inFront.dataset.idx = i;
        const inBack  = document.createElement('input'); inBack.className='form-control'; inBack.placeholder='Back'; inBack.value = f.back||''; inBack.dataset.idxBack = i;
        const controls = document.createElement('div'); controls.style.display='flex'; controls.style.flexDirection='column'; controls.style.gap='6px';
        const up = document.createElement('button'); up.className='btn btn-sm btn-ghost'; up.textContent='↑'; up.dataset.idx = i;
        const down = document.createElement('button'); down.className='btn btn-sm btn-ghost'; down.textContent='↓'; down.dataset.idx = i;
        controls.appendChild(up); controls.appendChild(down);
        const del = document.createElement('button'); del.className='btn btn-sm btn-danger'; del.textContent='×'; del.dataset.del = i;
        row.appendChild(inFront); row.appendChild(inBack); row.appendChild(controls); row.appendChild(del);
        flashList.appendChild(row);

        inFront.addEventListener('input', ()=>{ state.flashcards[i].front = inFront.value; autoSave(); renderPreview(); });
        inBack.addEventListener('input', ()=>{ state.flashcards[i].back = inBack.value; autoSave(); renderPreview(); });
        up.addEventListener('click', ()=>{ if(i>0){ swap(state.flashcards,i,i-1); renderFlashcards(); autoSave(); }});
        down.addEventListener('click', ()=>{ if(i<state.flashcards.length-1){ swap(state.flashcards,i,i+1); renderFlashcards(); autoSave(); }});
        del.addEventListener('click', ()=>{ state.flashcards.splice(i,1); renderFlashcards(); autoSave(); renderPreview(); });
      });
    }

    function addFlashcard(){ state.flashcards = state.flashcards || []; state.flashcards.push({front:'', back:''}); }

    /* QUIZ: improved layout + handlers */
    function renderQuiz(){
      quizList.innerHTML = '';
      const arr = state.quiz || [];
      if(!arr.length){ quizEmpty.style.display = 'block'; return; }
      quizEmpty.style.display = 'none';
      arr.forEach((q,i)=>{
        const block = document.createElement('div'); block.className = 'quiz-block';

        // Question (large rounded input)
        const question = document.createElement('textarea');
        question.className = 'quiz-question';
        question.placeholder = 'Question';
        question.rows = 2;
        question.value = q.question || '';
        question.dataset.idx = i;

        // choices grid (A,B top, C,D bottom)
        const choicesGrid = document.createElement('div'); choicesGrid.className = 'choices-grid';
        const choiceA = document.createElement('input'); choiceA.className='choice-input'; choiceA.placeholder='Choice A'; choiceA.value = q.choices?.[0]||''; choiceA.dataset.idx = i; choiceA.dataset.choice=0;
        const choiceB = document.createElement('input'); choiceB.className='choice-input'; choiceB.placeholder='Choice B'; choiceB.value = q.choices?.[1]||''; choiceB.dataset.idx = i; choiceB.dataset.choice=1;
        const choiceC = document.createElement('input'); choiceC.className='choice-input'; choiceC.placeholder='Choice C'; choiceC.value = q.choices?.[2]||''; choiceC.dataset.idx = i; choiceC.dataset.choice=2;
        const choiceD = document.createElement('input'); choiceD.className='choice-input'; choiceD.placeholder='Choice D'; choiceD.value = q.choices?.[3]||''; choiceD.dataset.idx = i; choiceD.dataset.choice=3;
        choicesGrid.appendChild(choiceA); choicesGrid.appendChild(choiceB); choicesGrid.appendChild(choiceC); choicesGrid.appendChild(choiceD);

        // controls row: correct index, explanation, remove
        const controls = document.createElement('div'); controls.className='quiz-controls';
        const correctLabel = document.createElement('div'); correctLabel.className='small-muted'; correctLabel.textContent='Correct index (0-3)';
        const correctInput = document.createElement('input'); correctInput.className='correct-input'; correctInput.value = (q.correctIndex != null ? q.correctIndex : 0); correctInput.dataset.idx = i;
        const explain = document.createElement('input'); explain.className='explain-input'; explain.placeholder = 'Why this answer is correct...'; explain.value = q.explanation || ''; explain.dataset.idx = i;
        const removeBtn = document.createElement('button'); removeBtn.className='remove-btn'; removeBtn.textContent = 'Remove';

        controls.appendChild(correctLabel);
        controls.appendChild(correctInput);
        controls.appendChild(explain);
        controls.appendChild(removeBtn);

        block.appendChild(question);
        block.appendChild(choicesGrid);
        block.appendChild(controls);
        quizList.appendChild(block);

        // Handlers
        question.addEventListener('input', ()=>{ state.quiz[i].question = question.value; autoSave(); });
        [choiceA,choiceB,choiceC,choiceD].forEach(ch => {
          ch.addEventListener('input', ()=>{ const idx = Number(ch.dataset.idx); const c = Number(ch.dataset.choice); state.quiz[idx].choices[c] = ch.value; autoSave(); });
        });
        correctInput.addEventListener('input', ()=>{ const val = Number(correctInput.value || 0); state.quiz[i].correctIndex = isNaN(val) ? 0 : val; autoSave(); });
        explain.addEventListener('input', ()=>{ state.quiz[i].explanation = explain.value; autoSave(); });
        removeBtn.addEventListener('click', ()=>{ state.quiz.splice(i,1); renderQuiz(); autoSave(); });
      });
    }

    function addQuiz(){ state.quiz = state.quiz || []; state.quiz.push({question:'', choices:['','','',''], correctIndex:0, explanation:''}); }

    /* SAVE / EXPORT / IMPORT */
    function onSave(){
      updateFromInputs();
      const hasTitle = !!state.meta.title;
      const hasContent = (state.notes && state.notes.length) || (state.flashcards && state.flashcards.length) || (state.quiz && state.quiz.length);
      if(!hasTitle){ document.getElementById('err-title').classList.remove('d-none'); titleEl.focus(); return; } else document.getElementById('err-title').classList.add('d-none');
      if(!hasContent){ alert('Add at least one of Notes, Flashcards or Quiz.'); return; }

      if(!currentId) currentId = generateId();
      const capsule = buildCapsule();
      try{
        localStorage.setItem(LS_CAP_PREFIX + currentId, JSON.stringify(capsule));
        upsertIndex({ id: currentId, title: capsule.meta.title, subject: capsule.meta.subject, level: capsule.meta.level, updatedAt: capsule.updatedAt });
        localStorage.removeItem(DRAFT_KEY);
        jsonOut.textContent = JSON.stringify(capsule, null, 2);
        alert('Saved — Library & Learn pages can read this capsule.');
      }catch(e){ console.error(e); alert('Save failed'); }
    }

    function onExport(){
      updateFromInputs();
      const blob = new Blob([JSON.stringify(buildCapsule(), null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = (slug(state.meta.title || 'capsule') || 'capsule') + '.json';
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    function onImportFile(e){
      const f = e.target.files?.[0];
      if(!f) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const parsed = JSON.parse(reader.result);
          if(parsed.schema !== 'pocket-classroom/v1'){ alert('Invalid schema'); return; }
          if(!parsed.meta || !parsed.meta.title){ alert('Missing title'); return; }
          currentId = null;
          state.meta = parsed.meta;
          state.notes = parsed.notes || [];
          state.flashcards = parsed.flashcards || [];
          state.quiz = parsed.quiz || [];
          renderAll();
          alert('Imported into editor. Press Save to persist as new capsule.');
        }catch(err){ alert('Import failed: ' + (err.message || err)); }
      };
      reader.readAsText(f);
    }

    function resetEditor(){
      if(!confirm('Reset editor? Unsaved draft will be removed.')) return;
      currentId = null;
      state = { meta:{title:'', subject:'', level:'Beginner', description:''}, notes:[], flashcards:[], quiz:[] };
      localStorage.removeItem(DRAFT_KEY);
      renderAll();
      jsonOut.textContent = '{ /* capsule JSON appears after Save */ }';
    }

    function buildCapsule(){
      return {
        schema: 'pocket-classroom/v1',
        id: currentId || generateId(),
        meta: { ...state.meta },
        notes: state.notes || [],
        flashcards: (state.flashcards || []).map(f=>({ front: f.front || '', back: f.back || '' })),
        quiz: (state.quiz || []).map(q=>({ question: q.question || '', choices: q.choices || ['', '', '', ''], correctIndex: q.correctIndex || 0, explanation: q.explanation || '' })),
        updatedAt: nowISO()
      };
    }

    function upsertIndex(entry){
      try{
        const raw = localStorage.getItem(LS_INDEX);
        const arr = raw ? JSON.parse(raw) : [];
        const idx = arr.findIndex(x=>x.id === entry.id);
        if(idx >= 0) arr[idx] = { ...arr[idx], ...entry };
        else arr.unshift(entry);
        localStorage.setItem(LS_INDEX, JSON.stringify(arr));
      }catch(e){ console.warn('index upsert failed', e); }
    }

    function generateId(){ return 'pc_' + Math.random().toString(36).slice(2,9); }
    function swap(a,i,j){ [a[i],a[j]] = [a[j],a[i]]; }

  })();
  </script>
</body>
</html>
